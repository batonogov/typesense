name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  api-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

      - name: Set up Task
        uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Cache Docker layers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Run API Tests
        run: task test-api
        env:
          TEST_API_KEY: ${{ secrets.TEST_API_KEY || 'API_KEY_TEST' }}
          TEST_TIMEOUT: 30

  performance-test:
    runs-on: ubuntu-latest
    needs: api-test
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

      - name: Set up Task
        uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Install wrk
        run: |
          sudo apt update
          sudo apt install -y wrk

      - name: Run Performance Tests
        run: task test-performance
        env:
          TEST_API_KEY: ${{ secrets.TEST_API_KEY || 'API_KEY_TEST' }}
          TEST_TIMEOUT: 30

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: test-logs
          path: |
            /tmp/typesense-test-*.log
          retention-days: 7
